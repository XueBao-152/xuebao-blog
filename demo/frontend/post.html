<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–‡ç« è¯¦æƒ… - å­¦å®åšå®¢</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/layout.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- ğŸ¯ ä¿®å¤è„šæœ¬1 - æ”¾åœ¨headé¡¶éƒ¨ -->
    <script>
        // ğŸ”§ é¢„åŠ è½½ä¿®å¤ï¼šç¡®ä¿API.getPostå­˜åœ¨
        (function() {
            console.log('ğŸ”§ é¢„åŠ è½½API.getPostä¿®å¤...');
            
            // å¦‚æœAPIä¸å­˜åœ¨ï¼Œåˆ›å»ºå®ƒ
            if (!window.API) {
                window.API = {};
                console.log('âœ… é¢„åŠ è½½ï¼šåˆ›å»ºAPIå¯¹è±¡');
            }
            
            // ç¡®ä¿getPostæ–¹æ³•å­˜åœ¨
            if (typeof window.API.getPost !== 'function') {
                console.log('âš ï¸ é¢„åŠ è½½ï¼šAPI.getPostä¸å­˜åœ¨ï¼Œæ·»åŠ ä¿®å¤...');
                
                window.API.getPost = async function(id) {
                    console.log(`ğŸ“„ é¢„åŠ è½½API.getPost: id=${id}`);
                    
                    try {
                        const token = localStorage.getItem('xuebao_token');
                        const response = await fetch(`http://localhost:8081/api/posts/${id}`, {
                            method: 'GET',
                            headers: {
                                'Content-Type': 'application/json',
                                ...(token ? { 'Authorization': `Bearer ${token}` } : {})
                            },
                            credentials: 'include',
                            mode: 'cors'
                        });
                        
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }
                        
                        const data = await response.json();
                        console.log('âœ… é¢„åŠ è½½API.getPostæˆåŠŸ');
                        return data;
                        
                    } catch (error) {
                        console.error('âŒ é¢„åŠ è½½API.getPostå¤±è´¥:', error);
                        throw error;
                    }
                };
                
                console.log('âœ… é¢„åŠ è½½API.getPostä¿®å¤å®Œæˆ');
            }
        })();
    </script>
    
    <style>
        /* æ‚¨çš„CSSæ ·å¼ä¿æŒä¸å˜ */
        .post-page {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px 0;
        }
        
        .back-button {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: #f8f9fa;
            color: #495057;
            text-decoration: none;
            border-radius: 6px;
            margin-bottom: 30px;
            transition: all 0.3s;
        }
        
        .back-button:hover {
            background: #e9ecef;
            transform: translateY(-1px);
        }
        
        .post-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .loading {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error-state {
            text-align: center;
            padding: 60px 20px;
            color: #dc3545;
        }
        
        .error-state i {
            font-size: 3rem;
            margin-bottom: 20px;
            opacity: 0.7;
        }
        
        .post-detail {
            padding: 40px;
        }
        
        .post-header {
            border-bottom: 1px solid #e9ecef;
            padding-bottom: 30px;
            margin-bottom: 30px;
        }
        
        .post-title {
            font-size: 2.5rem;
            font-weight: 700;
            color: #2c3e50;
            line-height: 1.3;
            margin-bottom: 20px;
        }
        
        .post-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .author-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .author-avatar {
            width: 50px;
            height: 50px;
            background: #3498db;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
        }
        
        .author-name {
            font-weight: 600;
            color: #2c3e50;
            font-size: 1.1rem;
        }
        
        .post-time {
            color: #6c757d;
            font-size: 0.9rem;
        }
        
        .post-stats {
            display: flex;
            gap: 20px;
            color: #6c757d;
        }
        
        .post-stats span {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .post-tags {
            margin: 20px 0;
        }
        
        .tag {
            display: inline-block;
            background: #e3f2fd;
            color: #1976d2;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            margin-right: 8px;
            margin-bottom: 8px;
        }
        
        .post-content {
            font-size: 1.1rem;
            line-height: 1.8;
            color: #2c3e50;
            margin-bottom: 40px;
        }
        
        .post-content p {
            margin-bottom: 1.5rem;
        }
        
        .post-footer {
            border-top: 1px solid #e9ecef;
            padding-top: 30px;
        }
        
        .post-actions {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .comments-section {
            margin-top: 50px;
        }
        
        .comments-section h2 {
            font-size: 1.8rem;
            color: #2c3e50;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 2px solid #3498db;
        }
        
        .comment-form-card {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .comment-form textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .comments-list {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .comment-item {
            padding: 20px 30px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .comment-item:last-child {
            border-bottom: none;
        }
        
        .comment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .comment-author {
            font-weight: 600;
            color: #2c3e50;
        }
        
        .comment-time {
            color: #6c757d;
            font-size: 0.85rem;
        }
        
        .comment-content {
            line-height: 1.6;
            color: #495057;
        }
        
        .no-comments {
            text-align: center;
            padding: 40px 20px;
            color: #6c757d;
            font-style: italic;
        }
        
        /* ===== æ–°å¢è¯„è®ºæ ·å¼ ===== */
        .comment-author-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .comment-avatar {
            width: 40px;
            height: 40px;
            background: #3498db;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
        }
        
        .comment-actions {
            display: flex;
            gap: 10px;
        }
        
        .comment-footer {
            display: flex;
            gap: 20px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #f0f0f0;
        }
        
        .comment-footer .btn-text {
            color: #6c757d;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 5px 10px;
            border-radius: 4px;
            transition: all 0.3s;
        }
        
        .comment-footer .btn-text:hover {
            background: #f8f9fa;
            color: #495057;
        }
        
        .reply-form {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 6px;
            display: none;
        }
        
        .reply-form.active {
            display: block;
        }
        
        .reply-form textarea {
            width: 100%;
            min-height: 80px;
            margin-bottom: 10px;
        }
        
        .reply-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        .empty-comments {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }
        
        .empty-comments i {
            font-size: 3rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }
        
        .login-prompt {
            text-align: center;
            padding: 30px;
            background: #f8f9fa;
            border-radius: 6px;
        }
        
        .login-prompt a {
            color: #3498db;
            text-decoration: none;
            font-weight: 600;
        }
        
        .login-prompt a:hover {
            text-decoration: underline;
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .post-page {
                padding: 10px;
            }
            
            .post-detail {
                padding: 20px;
            }
            
            .post-title {
                font-size: 2rem;
            }
            
            .post-meta {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .post-stats {
                width: 100%;
                justify-content: space-between;
            }
            
            .post-actions {
                flex-direction: column;
            }
            
            .post-actions .btn {
                width: 100%;
                text-align: center;
            }
            
            .comment-form-card {
                padding: 20px;
            }
            
            .comment-item {
                padding: 15px 20px;
            }
            
            .comment-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .comment-actions {
                align-self: flex-end;
            }
        }
    </style>
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar">
        <div class="container">
            <a href="index.html" class="logo">
                <i class="fas fa-book"></i>
                å­¦å®åšå®¢
            </a>
            
            <div class="nav-links" id="navLinks">
                <a href="index.html"><i class="fas fa-home"></i> é¦–é¡µ</a>
                <a href="create-post.html" id="createPostLink"><i class="fas fa-edit"></i> å†™æ–‡ç« </a>
                <a href="profile.html" id="profileLink"><i class="fas fa-user"></i> ä¸ªäººä¸­å¿ƒ</a>
                
                <div class="auth-buttons" id="authButtons">
                    <!-- ç™»å½•/æ³¨å†Œæˆ–ç”¨æˆ·ä¿¡æ¯ -->
                </div>
            </div>
            
            <button class="menu-toggle" onclick="toggleMenu()">
                <i class="fas fa-bars"></i>
            </button>
        </div>
    </nav>

    <!-- ä¸»å†…å®¹åŒº -->
    <main class="container">
        <div class="post-page">
            <!-- è¿”å›æŒ‰é’® -->
            <a href="index.html" class="back-button">
                <i class="fas fa-arrow-left"></i> è¿”å›é¦–é¡µ
            </a>
            
            <!-- æ–‡ç« å†…å®¹å®¹å™¨ -->
            <div id="postContainer" class="post-container">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p>æ­£åœ¨åŠ è½½æ–‡ç« ...</p>
                </div>
            </div>
            
            <!-- è¯„è®ºåŒºåŸŸ -->
            <section class="comments-section">
                <h2><i class="fas fa-comments"></i> è¯„è®º</h2>
                
                <!-- è¯„è®ºè¡¨å• -->
                <div class="comment-form-card" id="commentFormCard">
                    <form id="commentForm" class="comment-form">
                        <div class="form-group">
                            <textarea id="commentContent" class="form-control" 
                                      placeholder="å†™ä¸‹æ‚¨çš„è¯„è®º..." rows="4" required></textarea>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">å‘è¡¨è¯„è®º</button>
                        </div>
                    </form>
                </div>
                
                <!-- è¯„è®ºåˆ—è¡¨ -->
                <div id="commentsContainer" class="comments-list">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        <p>æ­£åœ¨åŠ è½½è¯„è®º...</p>
                    </div>
                </div>
            </section>
        </div>
    </main><!-- é¡µè„š -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h4>å­¦å®åšå®¢</h4>
                    <p>åˆ†äº«çŸ¥è¯†ï¼Œå…±åŒæˆé•¿çš„æŠ€æœ¯ç¤¾åŒº</p>
                </div>
                <div class="footer-section">
                    <h4>é“¾æ¥</h4>
                    <a href="index.html">é¦–é¡µ</a>
                    <a href="about.html">å…³äºæˆ‘ä»¬</a>
                    <a href="contact.html">è”ç³»æˆ‘ä»¬</a>
                </div>
                <div class="footer-section">
                    <h4>å…³æ³¨æˆ‘ä»¬</h4>
                    <div class="social-links">
                        <a href="#"><i class="fab fa-github"></i></a>
                        <a href="#"><i class="fab fa-weibo"></i></a>
                        <a href="#"><i class="fab fa-weixin"></i></a>
                    </div>
                </div>
            </div>
            <p class="copyright">Â© 2023 å­¦å®åšå®¢. ä¿ç•™æ‰€æœ‰æƒåˆ©.</p>
        </div>
    </footer>

    <!-- ğŸ”§ ä¿®å¤åçš„JavaScriptå¼•å…¥é¡ºåº -->
    <script src="js/utils.js"></script>
    <script src="js/api.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/comment.js"></script>
    <script src="js/post.js"></script>
    <script src="js/main.js"></script>
    
    <!-- ğŸ¯ ä¿®å¤åçš„è¯„è®ºç³»ç»Ÿåˆå§‹åŒ–è„šæœ¬ -->
    <script>
        // ğŸ”¥ ä¿®å¤ç‰ˆè¯„è®ºç³»ç»Ÿåˆå§‹åŒ–
        (function initCommentSystem() {
            console.log('ğŸ¯ åˆå§‹åŒ–è¯„è®ºç³»ç»Ÿ...');
            
            // ç­‰å¾…é¡µé¢å®Œå…¨åŠ è½½
            window.addEventListener('load', function() {
                console.log('=== é¡µé¢åŠ è½½å®Œæˆï¼Œåˆå§‹åŒ–è¯„è®ºç³»ç»Ÿ ===');
                
                // è·å–æ–‡ç« ID
                const urlParams = new URLSearchParams(window.location.search);
                const postId = urlParams.get('id');
                
                if (!postId) {
                    console.error('âŒ æ²¡æœ‰æ–‡ç« IDï¼Œæ— æ³•åŠ è½½è¯„è®º');
                    return;
                }
                
                console.log('ğŸ“„ å½“å‰æ–‡ç« ID:', postId);
                
                // æ£€æŸ¥ç»„ä»¶çŠ¶æ€
                console.log('ğŸ” æ£€æŸ¥ç»„ä»¶çŠ¶æ€:');
                console.log('- CommentManager:', window.CommentManager ? 'âœ… å­˜åœ¨' : 'âŒ ä¸å­˜åœ¨');
                console.log('- CommentManager.loadComments:', typeof window.CommentManager?.loadComments);
                console.log('- CommentManager.submitComment:', typeof window.CommentManager?.submitComment);
                console.log('- API.getPostComments:', typeof window.API?.getPostComments);
                
                // ğŸ”§ ä¿®å¤1ï¼šç¡®ä¿API.getPostCommentsæ­£ç¡®å¤„ç†å“åº”æ ¼å¼
                if (window.API && window.API.getPostComments) {
                    const originalGetPostComments = window.API.getPostComments;
                    window.API.getPostComments = async function(postId) {
                        try {
                            const response = await originalGetPostComments.call(this, postId);
                            console.log('ğŸ“¦ API.getPostCommentså“åº”:', response);
                            
                            // ğŸ”¥ ç¡®ä¿è¿”å›æ ‡å‡†æ ¼å¼
                            if (response && response.success !== undefined) {
                                return response;
                            } else if (Array.isArray(response)) {
                                return { success: true, data: response };
                            } else if (response && response.data !== undefined) {
                                return { success: true, data: response.data, message: response.message };
                            } else {
                                return { success: true, data: [] };
                            }
                        } catch (error) {
                            console.error('âŒ API.getPostCommentså¤±è´¥:', error);
                            throw error;
                        }
                    };
                    console.log('âœ… å·²ä¿®å¤API.getPostCommentsæ•°æ®æ ¼å¼å¤„ç†');
                }
                
                // ğŸ”§ ä¿®å¤2ï¼šç»‘å®šè¯„è®ºè¡¨å•
                const commentForm = document.getElementById('commentForm');
                if (commentForm) {
                    console.log('âœ… æ‰¾åˆ°è¯„è®ºè¡¨å•ï¼Œç»‘å®šäº‹ä»¶');
                    commentForm.onsubmit = function(e) {
                        e.preventDefault();
                        console.log('ğŸ“ è¯„è®ºè¡¨å•æäº¤');
                        
                        if (window.CommentManager && window.CommentManager.submitComment) {
                            window.CommentManager.submitComment(e, postId);
                        } else {
                            console.error('âŒ CommentManager.submitCommentä¸å¯ç”¨');
                            alert('è¯„è®ºåŠŸèƒ½æš‚ä¸å¯ç”¨');
                        }
                    };
                } else {
                    console.error('âŒ æ‰¾ä¸åˆ°è¯„è®ºè¡¨å•');
                }
                
                // ğŸ”§ ä¿®å¤3ï¼šæ£€æŸ¥ç™»å½•çŠ¶æ€ï¼Œæ›´æ–°è¯„è®ºè¡¨å•æ˜¾ç¤º
                const auth = window.Auth ? window.Auth.checkAuth() : { isLoggedIn: false };
                const commentFormCard = document.getElementById('commentFormCard');
                if (commentFormCard) {
                    if (auth.isLoggedIn) {
                        console.log('ğŸ‘¤ ç”¨æˆ·å·²ç™»å½•ï¼Œæ˜¾ç¤ºè¯„è®ºè¡¨å•');
                        commentFormCard.style.display = 'block';
                    } else {
                        console.log('ğŸ‘¤ ç”¨æˆ·æœªç™»å½•ï¼Œæ˜¾ç¤ºç™»å½•æç¤º');
                        commentFormCard.innerHTML = `
                            <div class="login-prompt">
                                <p>è¯· <a href="login.html?redirect=${encodeURIComponent(window.location.href)}">ç™»å½•</a> åå‘è¡¨è¯„è®º</p>
                            </div>
                        `;
                    }
                }
                
                // ğŸ”§ ä¿®å¤4ï¼šåŠ è½½è¯„è®º
                console.log('ğŸš€ å¼€å§‹åŠ è½½è¯„è®º...');
                if (window.CommentManager && typeof window.CommentManager.loadComments === 'function') {
                    setTimeout(() => {
                        window.CommentManager.loadComments(postId);
                    }, 500);
                } else {
                    console.error('âŒ CommentManager.loadCommentsä¸å¯ç”¨');
                    const container = document.getElementById('commentsContainer');
                    if (container) {
                        container.innerHTML = `
                            <div class="error-state">
                                <i class="fas fa-exclamation-triangle"></i>
                                <h3>è¯„è®ºç³»ç»ŸåŠ è½½å¤±è´¥</h3>
                                <p>è¯·åˆ·æ–°é¡µé¢é‡è¯•</p>
                            </div>
                        `;
                    }
                }
                
                console.log('âœ… è¯„è®ºç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');
            });
        })();
    </script>
    
    <!-- ğŸ”¥ æœ€ç»ˆä¿®å¤ï¼šç¡®ä¿æ–‡ç« æ­£ç¡®åŠ è½½ -->
    <script>
        (function finalFix() {
            console.log('ğŸ¯ å¯åŠ¨æœ€ç»ˆä¿®å¤è„šæœ¬...');
            
            // ç­‰å¾…é¡µé¢å®Œå…¨åŠ è½½
            window.addEventListener('load', function() {
                console.log('=== é¡µé¢åŠ è½½å®Œæˆï¼Œæœ€ç»ˆä¿®å¤ ===');
                
                const urlParams = new URLSearchParams(window.location.search);
                const postId = urlParams.get('id');
                
                if (!postId) {
                    console.error('âŒ æ²¡æœ‰æ–‡ç« ID');
                    return;
                }
                
                console.log('ğŸ“„ å½“å‰æ–‡ç« ID:', postId);
                
                // ğŸ”§ ä¿®å¤1ï¼šç¡®ä¿PostManagerå­˜åœ¨
                if (!window.PostManager) {
                    console.warn('âš ï¸ PostManagerä¸å­˜åœ¨ï¼Œåˆ›å»ºåº”æ€¥ç‰ˆæœ¬');
                    window.PostManager = {};
                }
                
                // ğŸ”§ ä¿®å¤2ï¼šç¡®ä¿loadPostæ–¹æ³•å­˜åœ¨
                if (typeof window.PostManager.loadPost !== 'function') {
                    console.warn('âš ï¸ PostManager.loadPostä¸å­˜åœ¨ï¼Œåˆ›å»ºåº”æ€¥æ–¹æ³•');
                    
                    window.PostManager.loadPost = async function(postId) {
                        console.log('ğŸš€ åº”æ€¥PostManager.loadPost:', postId);
                        
                        const container = document.getElementById('postContainer');
                        if (!container) {
                            console.error('âŒ æ‰¾ä¸åˆ°æ–‡ç« å®¹å™¨');
                            return;
                        }
                        
                        try {
                            container.innerHTML = '<div class="loading">æ­£åœ¨åŠ è½½æ–‡ç« ...</div>';
                            
                            // ç¡®ä¿APIå­˜åœ¨
                            if (!window.API || !window.API.getPost) {
                                throw new Error('API.getPostä¸å¯ç”¨');
                            }
                            
                            // è°ƒç”¨API
                            console.log('ğŸ“¡ è°ƒç”¨API.getPost...');
                            const response = await window.API.getPost(postId);
                            console.log('âœ… APIå“åº”æˆåŠŸ:', response);
                            
                            // æå–æ–‡ç« æ•°æ®
                            const post = response.data || response;
                            
                            if (!post) {
                                throw new Error('æ–‡ç« æ•°æ®ä¸ºç©º');
                            }
                            
                            // æ¸²æŸ“æ–‡ç« 
                            this.renderPost(container, post);
                            
                            console.log('âœ… æ–‡ç« åŠ è½½å®Œæˆ');
                            
                        } catch (error) {
                            console.error('âŒ åŠ è½½æ–‡ç« å¤±è´¥:', error);
                            this.showError('æ–‡ç« åŠ è½½å¤±è´¥: ' + error.message);
                        }
                    };
                    
                    // æ·»åŠ è¾…åŠ©æ–¹æ³•
                    window.PostManager.renderPost = function(container, post) {
                        const author = this.getAuthorName(post.author);
                        const dateStr = this.formatDate(post.createdAt);
                        
                        container.innerHTML = `
                            <div class="post-detail">
                                <div class="post-header">
                                    <h1 class="post-title">${this.escapeHtml(post.title || 'æ— æ ‡é¢˜')}</h1>
                                    <div class="post-meta">
                                        <div class="author-info">
                                            <div class="author-avatar">
                                                <i class="fas fa-user-circle"></i>
                                            </div>
                                            <div>
                                                <div class="author-name">${this.escapeHtml(author)}</div>
                                                <div class="post-time">${dateStr}</div>
                                            </div>
                                        </div>
                                        <div class="post-stats">
                                            <span><i class="far fa-eye"></i> ${post.viewCount || 0} é˜…è¯»</span>
                                            <span><i class="far fa-heart"></i> ${post.likeCount || 0} ç‚¹èµ</span>
                                            <span><i class="far fa-comment"></i> ${post.commentCount || 0} è¯„è®º</span>
                                        </div>
                                    </div>
                                </div>
                                
                                ${post.keywords ? `
                                    <div class="post-tags">
                                        ${(typeof post.keywords === 'string' ? post.keywords.split(',') : post.keywords)
                                            .map(k => `<span class="tag">${this.escapeHtml(k.trim())}</span>`)
                                            .join('')}
                                    </div>
                                ` : ''}
                                
                                <div class="post-content">
                                    ${(post.content || '').replace(/\n/g, '<br>')}
                                </div>
                                
                                <div class="post-footer">
                                    <div class="post-actions">
                                        <button class="btn btn-outline" onclick="alert('ç‚¹èµåŠŸèƒ½å¼€å‘ä¸­')">
                                            <i class="far fa-heart"></i> ç‚¹èµ
                                        </button>
                                        <button class="btn btn-outline" onclick="document.getElementById('commentForm').scrollIntoView()">
                                            <i class="far fa-comment"></i> è¯„è®º
                                        </button>
                                        <a href="index.html" class="btn btn-outline">è¿”å›é¦–é¡µ</a>
                                    </div>
                                </div>
                            </div>
                        `;
                    };
                    
                    window.PostManager.getAuthorName = function(author) {
                        if (!author) return 'åŒ¿å';
                        if (typeof author === 'string') return author;
                        if (author.username) return author.username;
                        if (author.nickname) return author.nickname;
                        if (author.name) return author.name;
                        return 'åŒ¿å';
                    };
                    
                    window.PostManager.formatDate = function(dateString) {
                        if (!dateString) return 'æœªçŸ¥æ—¶é—´';
                        try {
                            const date = new Date(dateString);
                            return date.toLocaleDateString('zh-CN') + ' ' + 
                                   date.toLocaleTimeString('zh-CN', {hour: '2-digit', minute:'2-digit'});
                        } catch (e) {
                            return dateString;
                        }
                    };
                    
                    window.PostManager.escapeHtml = function(text) {
                        if (!text) return '';
                        return String(text)
                            .replace(/&/g, "&amp;")
                            .replace(/</g, "&lt;")
                            .replace(/>/g, "&gt;")
                            .replace(/"/g, "&quot;")
                            .replace(/'/g, "&#039;");
                    };
                    
                    window.PostManager.showError = function(message) {
                        const container = document.getElementById('postContainer');
                        if (!container) return;
                        
                        container.innerHTML = `
                            <div class="error-state">
                                <i class="fas fa-exclamation-triangle"></i>
                                <h3>é¡µé¢åŠ è½½å¤±è´¥</h3>
                                <p>${message}</p>
                                <button onclick="location.reload()" class="btn btn-primary">åˆ·æ–°é¡µé¢</button>
                            </div>
                        `;
                    };
                    
                    console.log('âœ… åº”æ€¥PostManageråˆ›å»ºå®Œæˆ');
                }
                
                // ğŸ”§ ä¿®å¤3ï¼šç¡®ä¿CommentManager.loadCommentså­˜åœ¨
                if (window.CommentManager && typeof window.CommentManager.loadComments !== 'function') {
                    console.warn('âš ï¸ CommentManager.loadCommentsä¸å­˜åœ¨ï¼Œåˆ›å»ºåº”æ€¥æ–¹æ³•');
                    
                    window.CommentManager.loadComments = async function(postId) {
                        console.log('ğŸ”§ åº”æ€¥CommentManager.loadComments:', postId);
                        
                        const container = document.getElementById('commentsContainer');
                        if (!container) {
                            console.error('âŒ æ‰¾ä¸åˆ°è¯„è®ºå®¹å™¨');
                            return;
                        }
                        
                        try {
                            container.innerHTML = '<div class="loading">æ­£åœ¨åŠ è½½è¯„è®º...</div>';
                            
                            if (!window.API || !window.API.getPostComments) {
                                throw new Error('API.getPostCommentsä¸å¯ç”¨');
                            }
                            
                            const response = await window.API.getPostComments(postId);
                            console.log('ğŸ“¦ è¯„è®ºæ•°æ®:', response);
                            
                            if (container) {
                                if (response.data && response.data.length > 0) {
                                    container.innerHTML = response.data.map(comment => {
                                        const commentData = comment.data || comment;
                                        const author = commentData.author?.username || commentData.author || 'åŒ¿åç”¨æˆ·';
                                        const content = commentData.content || '';
                                        const createdAt = commentData.createdAt || new Date().toISOString();
                                        
                                        return `
                                            <div class="comment-item">
                                                <div class="comment-header">
                                                    <div class="comment-author-info">
                                                        <div class="comment-avatar">
                                                            <i class="fas fa-user-circle"></i>
                                                        </div>
                                                        <div>
                                                            <div class="comment-author">${author}</div>
                                                            <div class="comment-time">${new Date(createdAt).toLocaleString()}</div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="comment-content">${content.replace(/\n/g, '<br>')}</div>
                                            </div>
                                        `;
                                    }).join('');
                                } else {
                                    container.innerHTML = '<div class="no-comments">æš‚æ— è¯„è®º</div>';
                                }
                            }
                        } catch (error) {
                            console.error('âŒ åŠ è½½è¯„è®ºå¤±è´¥:', error);
                            if (container) {
                                container.innerHTML = '<div class="error-state">åŠ è½½è¯„è®ºå¤±è´¥</div>';
                            }
                        }
                    };
                }
                
                // ğŸ”§ ä¿®å¤4ï¼šæ›´æ–°å¯¼èˆªæ 
                if (window.Auth && typeof window.Auth.updateNavbar === 'function') {
                    window.Auth.updateNavbar();
                }
                
                // ğŸ”§ ä¿®å¤5ï¼šæœ€ç»ˆéªŒè¯å¹¶åŠ è½½æ–‡ç« 
                console.log('ğŸ” æœ€ç»ˆéªŒè¯:');
                console.log('API.getPost:', typeof window.API?.getPost);
                console.log('PostManager.loadPost:', typeof window.PostManager?.loadPost);
                console.log('CommentManager.loadComments:', typeof window.CommentManager?.loadComments);
                
                if (typeof window.PostManager.loadPost === 'function') {
                    console.log('ğŸš€ å¼€å§‹åŠ è½½æ–‡ç« ...');
                    window.PostManager.loadPost(postId);
                } else {
                    console.error('âŒ æœ€ç»ˆä¿®å¤å¤±è´¥ï¼šPostManager.loadPostä»ç„¶ä¸å¯ç”¨');
                    showError('é¡µé¢ç»„ä»¶åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢');
                }
                
                console.log('âœ… æœ€ç»ˆä¿®å¤å®Œæˆ');
            });
            
            // å·¥å…·å‡½æ•°
            function showError(message) {
                const container = document.getElementById('postContainer');
                if (container) {
                    container.innerHTML = `
                        <div class="error-state">
                            <i class="fas fa-exclamation-triangle"></i>
                            <h3>é¡µé¢åŠ è½½å¤±è´¥</h3>
                            <p>${message}</p>
                            <button onclick="location.reload()" class="btn btn-primary">åˆ·æ–°é¡µé¢</button>
                        </div>
                    `;
                }
            }
            
            // ç§»åŠ¨ç«¯èœå•
            window.toggleMenu = function() {
                const navLinks = document.getElementById('navLinks');
                if (navLinks) {
                    navLinks.classList.toggle('active');
                }
            };
        })();
    </script>
    <script>
    // ğŸ”§ ç¡®ä¿è¯„è®ºè¡¨å•æ­£ç¡®ç»‘å®š
    (function ensureFormBinding() {
        console.log('ğŸ”§ ç¡®ä¿è¯„è®ºè¡¨å•ç»‘å®š...');
        
        window.addEventListener('load', function() {
            setTimeout(() => {
                const commentForm = document.getElementById('commentForm');
                if (!commentForm) {
                    console.error('âŒ æ‰¾ä¸åˆ°è¯„è®ºè¡¨å•');
                    return;
                }
                
                const postId = new URLSearchParams(window.location.search).get('id');
                if (!postId) {
                    console.error('âŒ æ‰¾ä¸åˆ°æ–‡ç« ID');
                    return;
                }
                
                // ç§»é™¤æ—§çš„ç»‘å®š
                commentForm.onsubmit = null;
                
                // ç»‘å®šæ–°çš„æäº¤äº‹ä»¶
                commentForm.onsubmit = function(e) {
                    e.preventDefault();
                    console.log('ğŸ“ è¡¨å•æäº¤è§¦å‘');
                    
                    if (window.CommentManager && typeof window.CommentManager.submitComment === 'function') {
                        window.CommentManager.submitComment(e, postId);
                    } else {
                        console.error('âŒ CommentManager.submitCommentä¸å¯ç”¨');
                        alert('è¯„è®ºåŠŸèƒ½æš‚ä¸å¯ç”¨');
                    }
                };
                
                console.log('âœ… è¯„è®ºè¡¨å•ç»‘å®šå®Œæˆ');
            }, 1000);
        });
    })();
</script>
</body>
</html>