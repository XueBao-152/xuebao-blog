<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸ªäººä¸­å¿ƒ - å­¦å®åšå®¢</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/layout.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .profile-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .profile-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .profile-avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: white;
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            color: #667eea;
            font-weight: bold;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .profile-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }
        
        .profile-name {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .profile-role {
            display: inline-block;
            background: rgba(255,255,255,0.2);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
        }
        
        .profile-stats {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin-top: 20px;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .profile-content {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 30px;
        }
        
        .profile-sidebar {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
        }
        
        .profile-menu {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .profile-menu li {
            margin-bottom: 5px;
        }
        
        .profile-menu a {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            color: #333;
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.2s;
        }
        
        .profile-menu a:hover {
            background: #f8f9fa;
            color: #007bff;
        }
        
        .profile-menu a.active {
            background: #007bff;
            color: white;
        }
        
        .profile-menu a i {
            width: 20px;
            margin-right: 10px;
        }
        
        .profile-main {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 30px;
        }
        
        .profile-section {
            margin-bottom: 40px;
        }
        
        .profile-section h2 {
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .info-group {
            margin-bottom: 20px;
        }
        
        .info-label {
            font-weight: 600;
            color: #666;
            margin-bottom: 5px;
        }
        
        .info-value {
            font-size: 16px;
            color: #333;
        }
        
        .edit-profile-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .edit-profile-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102,126,234,0.4);
        }
        
        @media (max-width: 768px) {
            .profile-content {
                grid-template-columns: 1fr;
            }
            
            .profile-stats {
                flex-wrap: wrap;
                gap: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-logo">
                <a href="index.html" class="logo">
                    <i class="fas fa-book-open"></i> å­¦å®åšå®¢
                </a>
            </div>
            
            <div class="nav-menu">
                <a href="index.html" class="nav-link">
                    <i class="fas fa-home"></i> é¦–é¡µ
                </a>
                <a href="categories.html" class="nav-link">
                    <i class="fas fa-th"></i> åˆ†ç±»
                </a>
                <a href="tags.html" class="nav-link">
                    <i class="fas fa-tags"></i> æ ‡ç­¾
                </a>
                <a href="about.html" class="nav-link">
                    <i class="fas fa-info-circle"></i> å…³äº
                </a>
                
                <!-- ç”¨æˆ·çŠ¶æ€ -->
                <div id="userStatus" class="user-status">
                    <!-- åŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
        </div>
    </nav>
    
    <!-- ä¸ªäººä¸­å¿ƒå†…å®¹ -->
    <div class="profile-container">
        <div id="profileHeader" class="profile-header">
            <div class="profile-avatar" id="userAvatar">
                <!-- å¤´åƒåŠ¨æ€ç”Ÿæˆ -->
            </div>
            <div class="profile-name" id="userName">åŠ è½½ä¸­...</div>
            <div class="profile-role" id="userRole">ç”¨æˆ·</div>
            <div class="profile-stats">
                <div class="stat-item">
                    <div class="stat-number" id="postCount">0</div>
                    <div class="stat-label">æ–‡ç« </div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="followerCount">0</div>
                    <div class="stat-label">ç²‰ä¸</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="followingCount">0</div>
                    <div class="stat-label">å…³æ³¨</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="likeCount">0</div>
                    <div class="stat-label">è·èµ</div>
                </div>
            </div>
        </div>
        
        <div class="profile-content">
            <div class="profile-sidebar">
                <ul class="profile-menu">
                    <li><a href="#info" class="active" onclick="showSection('info')">
                        <i class="fas fa-user"></i> ä¸ªäººä¿¡æ¯
                    </a></li>
                    <li><a href="#posts" onclick="showSection('posts')">
                        <i class="fas fa-file-alt"></i> æˆ‘çš„æ–‡ç« 
                    </a></li>
                    <li><a href="#drafts" onclick="showSection('drafts')">
                        <i class="fas fa-edit"></i> è‰ç¨¿ç®±
                    </a></li>
                    <li><a href="#comments" onclick="showSection('comments')">
                        <i class="fas fa-comment"></i> æˆ‘çš„è¯„è®º
                    </a></li>
                    <li><a href="#likes" onclick="showSection('likes')">
                        <i class="fas fa-heart"></i> æˆ‘çš„ç‚¹èµ
                    </a></li>
                    <li><a href="#settings" onclick="showSection('settings')">
                        <i class="fas fa-cog"></i> è´¦æˆ·è®¾ç½®
                    </a></li>
                </ul>
                
                <button class="edit-profile-btn" style="width: 100%; margin-top: 20px;">
                    <i class="fas fa-edit"></i> ç¼–è¾‘èµ„æ–™
                </button>
            </div>
            
            <div class="profile-main">
                <div id="infoSection" class="profile-section">
                    <h2>ä¸ªäººä¿¡æ¯</h2>
                    <div class="info-group">
                        <div class="info-label">ç”¨æˆ·å</div>
                        <div class="info-value" id="profileUsername">-</div>
                    </div>
                    <div class="info-group">
                        <div class="info-label">æ˜µç§°</div>
                        <div class="info-value" id="profileNickname">-</div>
                    </div>
                    <div class="info-group">
                        <div class="info-label">é‚®ç®±</div>
                        <div class="info-value" id="profileEmail">-</div>
                    </div>
                    <div class="info-group">
                        <div class="info-label">æ³¨å†Œæ—¶é—´</div>
                        <div class="info-value" id="profileJoinDate">-</div>
                    </div>
                    <div class="info-group">
                        <div class="info-label">ä¸ªäººç®€ä»‹</div>
                        <div class="info-value" id="profileBio">æš‚æ— ä¸ªäººç®€ä»‹</div>
                    </div>
                </div>
                
                <div id="postsSection" class="profile-section" style="display: none;">
                    <h2>æˆ‘çš„æ–‡ç« </h2>
                    <div id="myPostsList">åŠ è½½ä¸­...</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- å¼•å…¥è„šæœ¬ -->
    <script src="js/utils.js"></script>
    <script src="js/api.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/user.js"></script>
    
    <script>
        // é¡µé¢åŠ è½½å®Œæˆ
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ä¸ªäººä¸­å¿ƒé¡µé¢åŠ è½½');
            
            // æ£€æŸ¥ç™»å½•çŠ¶æ€
            if (!Auth.protectPage()) {
                return;
            }
            
            // æ¸²æŸ“ç”¨æˆ·çŠ¶æ€
            if (window.UserManager && typeof window.UserManager.renderUserStatus === 'function') {
                window.UserManager.renderUserStatus();
            } else {
                updateAuthButtons();
            }
            
            // åŠ è½½ç”¨æˆ·ä¿¡æ¯
            loadUserProfile();
            
            // åŠ è½½ç”¨æˆ·ç»Ÿè®¡
            loadUserStats();
            
            // åŠ è½½ç”¨æˆ·æ–‡ç« 
            loadUserPosts();
        });
        
        // åŠ è½½ç”¨æˆ·ä¿¡æ¯
        async function loadUserProfile() {
            try {
                const user = UserManager.getCurrentUser();
                if (!user) {
                    window.location.href = 'login.html';
                    return;
                }
                
                // æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
                document.getElementById('userName').textContent = UserManager.getUserName(user);
                document.getElementById('userRole').textContent = UserManager.getUserRole(user);
                document.getElementById('profileUsername').textContent = user.username || '-';
                document.getElementById('profileNickname').textContent = user.nickname || user.username || '-';
                document.getElementById('profileEmail').textContent = user.email || '-';
                document.getElementById('profileBio').textContent = user.bio || 'æš‚æ— ä¸ªäººç®€ä»‹';
                
                // æ ¼å¼åŒ–æ³¨å†Œæ—¶é—´
                if (user.createdAt) {
                    const joinDate = new Date(user.createdAt).toLocaleDateString('zh-CN');
                    document.getElementById('profileJoinDate').textContent = joinDate;
                }
                
                // è®¾ç½®å¤´åƒ
                const avatar = UserManager.getUserAvatar(user);
                const avatarElement = document.getElementById('userAvatar');
                if (avatar) {
                    avatarElement.innerHTML = `<img src="${avatar}" alt="${user.username}">`;
                } else {
                    const firstChar = (user.username || 'ç”¨æˆ·').charAt(0).toUpperCase();
                    avatarElement.innerHTML = `<span>${firstChar}</span>`;
                }
                
            } catch (error) {
                console.error('åŠ è½½ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
                Utils.showMessage('åŠ è½½ç”¨æˆ·ä¿¡æ¯å¤±è´¥', 'error');
            }
        }
        
        // åŠ è½½ç”¨æˆ·ç»Ÿè®¡
        async function loadUserStats() {
            // è¿™é‡Œä»APIè·å–ç”¨æˆ·ç»Ÿè®¡æ•°æ®
            // æš‚æ—¶ç”¨æ¨¡æ‹Ÿæ•°æ®
            setTimeout(() => {
                document.getElementById('postCount').textContent = '12';
                document.getElementById('followerCount').textContent = '156';
                document.getElementById('followingCount').textContent = '42';
                document.getElementById('likeCount').textContent = '1.2K';
            }, 500);
        }
        
        // åŠ è½½ç”¨æˆ·æ–‡ç« 
        async function loadUserPosts() {
            try {
                const posts = await API.getMyPosts();
                if (posts && posts.content && posts.content.length > 0) {
                    const postsHTML = posts.content.map(post => `
                        <div class="post-card" style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <h4><a href="post.html?id=${post.id}">${post.title}</a></h4>
                            <p>${post.content.substring(0, 100)}${post.content.length > 100 ? '...' : ''}</p>
                            <div style="font-size: 12px; color: #6c757d;">
                                <span>${Utils.formatDate(post.createdAt)}</span>
                                <span style="margin-left: 20px;">ğŸ‘ï¸ ${post.viewCount || 0} æµè§ˆ</span>
                                <span style="margin-left: 20px;">â¤ï¸ ${post.likeCount || 0} ç‚¹èµ</span>
                            </div>
                        </div>
                    `).join('');
                    
                    document.getElementById('myPostsList').innerHTML = postsHTML;
                } else {
                    document.getElementById('myPostsList').innerHTML = '<p>æš‚æ— æ–‡ç« ï¼Œ<a href="create-post.html">ç«‹å³å‘å¸ƒ</a></p>';
                }
            } catch (error) {
                console.error('åŠ è½½ç”¨æˆ·æ–‡ç« å¤±è´¥:', error);
                document.getElementById('myPostsList').innerHTML = '<p>åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•</p>';
            }
        }
        
        // æ˜¾ç¤ºä¸åŒéƒ¨åˆ†
        function showSection(sectionId) {
            // éšè—æ‰€æœ‰éƒ¨åˆ†
            document.querySelectorAll('.profile-section').forEach(section => {
                section.style.display = 'none';
            });
            
            // æ˜¾ç¤ºé€‰ä¸­çš„éƒ¨åˆ†
            document.getElementById(sectionId + 'Section').style.display = 'block';
            
            // æ›´æ–°èœå•æ¿€æ´»çŠ¶æ€
            document.querySelectorAll('.profile-menu a').forEach(link => {
                link.classList.remove('active');
            });
            document.querySelector(`.profile-menu a[href="#${sectionId}"]`).classList.add('active');
        }
        
        // ç¼–è¾‘èµ„æ–™
        document.querySelector('.edit-profile-btn').addEventListener('click', function() {
            Utils.showMessage('ç¼–è¾‘èµ„æ–™åŠŸèƒ½å¼€å‘ä¸­...', 'info');
        });
        
        // å¤‡ç”¨å‡½æ•°
        function updateAuthButtons() {
            const token = localStorage.getItem('xuebao_token');
            const userStatus = document.getElementById('userStatus');
            
            if (token && userStatus) {
                const userData = localStorage.getItem('xuebao_user');
                let user = null;
                try {
                    user = userData ? JSON.parse(userData) : null;
                } catch (e) {}
                
                const username = user?.username || 'ç”¨æˆ·';
                const firstLetter = username.charAt(0).toUpperCase();
                
                userStatus.innerHTML = `
                    <div class="user-menu">
                        <div class="user-info" onclick="window.location.href='profile.html'" 
                             style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <div style="width: 36px; height: 36px; border-radius: 50%; background: linear-gradient(135deg, #667eea, #764ba2); 
                                    display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
                                ${firstLetter}
                            </div>
                            <span style="font-weight: 500;">${username}</span>
                        </div>
                    </div>
                `;
            }
        }
    </script>
</body>
</html>