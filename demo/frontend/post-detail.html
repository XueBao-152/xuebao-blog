<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–‡ç« è¯¦æƒ… - å­¦å®åšå®¢</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/layout.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* æ–‡ç« è¯¦æƒ…é¡µä¸“ç”¨æ ·å¼ */
        .post-detail-page {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .post-header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 30px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .post-title {
            color: #2c3e50;
            font-size: 2.5rem;
            margin-bottom: 15px;
            line-height: 1.3;
        }
        
        .post-meta {
            color: #6c757d;
            font-size: 1.1rem;
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .post-meta-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .post-tags {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }
        
        .tag {
            background: #e9ecef;
            color: #495057;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
        }
        
        .post-content {
            background: white;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            line-height: 1.8;
            font-size: 1.1rem;
        }
        
        .post-content h1, .post-content h2, .post-content h3 {
            color: #2c3e50;
            margin: 30px 0 15px 0;
        }
        
        .post-content p {
            margin-bottom: 20px;
        }
        
        .post-content code {
            background: #f8f9fa;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
        }
        
        .post-content pre {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 6px;
            overflow-x: auto;
            margin: 20px 0;
        }
        
        .post-actions {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 30px 0;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }
        
        .btn-outline {
            background: white;
            color: #6c757d;
            border: 1px solid #6c757d;
        }
        
        .btn-outline:hover {
            background: #f8f9fa;
            transform: translateY(-1px);
        }
        
        .btn-primary {
            background: #3498db;
            color: white;
        }
        
        .btn-primary:hover {
            background: #2980b9;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(52, 152, 219, 0.3);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }
        
        .stats-container {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin: 20px 0;
        }
        
        .stat-item {
            text-align: center;
            padding: 15px;
        }
        
        .stat-number {
            font-size: 1.5rem;
            font-weight: bold;
            color: #3498db;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: #6c757d;
        }
        
        /* è¯„è®ºåŒºåŸŸ */
        .comments-section {
            margin-top: 50px;
        }
        
        .section-title {
            font-size: 1.5rem;
            color: #2c3e50;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #3498db;
        }
        
        .comment-form {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .comment-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            margin-bottom: 15px;
            resize: vertical;
            min-height: 100px;
            font-family: inherit;
            font-size: 14px;
        }
        
        .comment-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        
        .comments-list {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .comment-item {
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
            transition: background-color 0.2s;
        }
        
        .comment-item:hover {
            background-color: #f8f9fa;
        }
        
        .comment-item:last-child {
            border-bottom: none;
        }
        
        .comment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .comment-author {
            font-weight: bold;
            color: #2c3e50;
        }
        
        .comment-time {
            color: #6c757d;
            font-size: 0.9rem;
        }
        
        .comment-content {
            color: #495057;
            line-height: 1.6;
            white-space: pre-wrap;
        }
        
        /* å“åº”å¼ */
        @media (max-width: 768px) {
            .post-detail-page {
                padding: 10px;
            }
            
            .post-title {
                font-size: 2rem;
            }
            
            .post-content {
                padding: 20px;
            }
            
            .post-meta {
                flex-direction: column;
                gap: 10px;
            }
            
            .stats-container {
                flex-direction: column;
                gap: 15px;
            }
            
            .post-actions {
                flex-direction: column;
            }
        }
        
        /* åŠ è½½çŠ¶æ€ */
        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }
        
        .loading i {
            margin-right: 10px;
        }
        
        .error {
            text-align: center;
            padding: 40px;
            color: #dc3545;
            background: #f8d7da;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #f5c6cb;
        }
        
        .success {
            text-align: center;
            padding: 40px;
            color: #155724;
            background: #d4edda;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #c3e6cb;
        }
        
        /* æ¶ˆæ¯æç¤º */
        .message {
            padding: 12px 20px;
            border-radius: 6px;
            margin-bottom: 20px;
            display: none;
        }
        
        .message-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .message-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .message-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
    </style>
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar">
        <div class="container">
            <a href="index.html" class="logo">
                <i class="fas fa-book"></i>
                å­¦å®åšå®¢
            </a>
            
            <div class="nav-links" id="navLinks">
                <a href="index.html"><i class="fas fa-home"></i> é¦–é¡µ</a>
                <a href="create-post.html"><i class="fas fa-edit"></i> å†™æ–‡ç« </a>
                <a href="profile.html" id="profileLink"><i class="fas fa-user"></i> ä¸ªäººä¸­å¿ƒ</a>
                
                <div class="auth-buttons" id="authButtons">
                    <!-- ç™»å½•/æ³¨å†Œæˆ–ç”¨æˆ·ä¿¡æ¯ -->
                </div>
            </div>
            
            <button class="menu-toggle" onclick="toggleMenu()">
                <i class="fas fa-bars"></i>
            </button>
        </div>
    </nav>

    <!-- ä¸»å†…å®¹åŒº -->
    <main class="container">
        <div class="post-detail-page">
            <!-- æ¶ˆæ¯æç¤º -->
            <div id="message" class="message" style="display: none;"></div>
            
            <!-- åŠ è½½çŠ¶æ€ -->
            <div id="loading" class="loading">
                <i class="fas fa-spinner fa-spin"></i> åŠ è½½ä¸­...
            </div>
            
            <!-- é”™è¯¯æç¤º -->
            <div id="error" class="error" style="display: none;"></div>
            
            <!-- æ–‡ç« å†…å®¹ -->
            <div id="postContent" style="display: none;">
                <!-- æ–‡ç« å¤´éƒ¨ -->
                <div class="post-header">
                    <h1 class="post-title" id="postTitle"></h1>
                    
                    <div class="post-meta">
                        <div class="post-meta-item">
                            <i class="fas fa-user"></i>
                            <span id="postAuthor"></span>
                        </div>
                        <div class="post-meta-item">
                            <i class="fas fa-calendar"></i>
                            <span id="postDate"></span>
                        </div>
                        <div class="post-meta-item">
                            <i class="fas fa-eye"></i>
                            <span id="postViews">0</span> æ¬¡é˜…è¯»
                        </div>
                    </div>
                    
                    <div class="post-tags" id="postTags"></div>
                </div>
                
                <!-- ç»Ÿè®¡æ•°æ® -->
                <div class="stats-container">
                    <div class="stat-item">
                        <div class="stat-number" id="likeCount">0</div>
                        <div class="stat-label">ç‚¹èµ</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="commentCount">0</div>
                        <div class="stat-label">è¯„è®º</div>
                    </div>
                </div>
                
                <!-- æ“ä½œæŒ‰é’® -->
                <div class="post-actions">
                    <button class="btn btn-outline" onclick="window.history.back()">
                        <i class="fas fa-arrow-left"></i> è¿”å›
                    </button>
                    <button class="btn btn-primary" id="likeBtn" onclick="toggleLike()">
                        <i class="far fa-heart"></i> ç‚¹èµ
                    </button>
                    <a href="index.html" class="btn btn-outline">
                        <i class="fas fa-home"></i> è¿”å›é¦–é¡µ
                    </a>
                </div>
                
                <!-- æ–‡ç« å†…å®¹ -->
                <div class="post-content" id="postContentText"></div>
                
                <!-- è¯„è®ºåŒºåŸŸ -->
                <div class="comments-section">
                    <h3 class="section-title">
                        <i class="fas fa-comments"></i> è¯„è®º
                        <span id="commentsCount">(0)</span>
                    </h3>
                    
                    <!-- è¯„è®ºè¡¨å• -->
                    <div class="comment-form" id="commentForm">
                        <textarea class="comment-input" id="commentText" 
                                  placeholder="å†™ä¸‹æ‚¨çš„è¯„è®º..."></textarea>
                        <button class="btn btn-primary" id="submitCommentBtn" onclick="submitComment()">
                            <i class="fas fa-paper-plane"></i> å‘è¡¨è¯„è®º
                        </button>
                    </div>
                    
                    <!-- è¯„è®ºåˆ—è¡¨ -->
                    <div class="comments-list" id="commentsList">
                        <div class="loading">åŠ è½½è¯„è®ºä¸­...</div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- å¼•å…¥JavaScript -->
    <script src="js/utils.js"></script>
    <script src="js/api.js"></script>
    <script src="js/auth.js"></script>
    
    <script>
        // ğŸ”¥ ç«‹å³ä¿®å¤ï¼šç¡®ä¿APIå¯¹è±¡å­˜åœ¨
        console.log('=== æ–‡ç« è¯¦æƒ…é¡µå¼€å§‹åŠ è½½ ===');
        
        // æ£€æŸ¥APIå¯¹è±¡æ˜¯å¦å­˜åœ¨
        if (!window.API) {
            console.warn('âš ï¸ window.API ä¸å­˜åœ¨ï¼Œç«‹å³åˆ›å»º');
            window.API = {};
        }
        
        // ç¡®ä¿APIæœ‰åŸºç¡€URL
        if (!window.API.baseURL) {
            window.API.baseURL = 'http://localhost:8081';
        }
        
        // ğŸ”¥ å…³é”®ä¿®å¤ï¼šç¡®ä¿API.getPostæ–¹æ³•å­˜åœ¨
        if (typeof window.API.getPost !== 'function') {
            console.warn('âš ï¸ API.getPost ä¸å­˜åœ¨ï¼Œåˆ›å»ºå¤‡ç”¨æ–¹æ³•');
            
            window.API.getPost = async function(id) {
                console.log(`ğŸ”§ å¤‡ç”¨ getPost è¢«è°ƒç”¨: id=${id}`);
                
                const url = `${this.baseURL}/api/posts/${id}`;
                const token = localStorage.getItem('xuebao_token');
                
                try {
                    console.log(`ğŸ“¡ è·å–æ–‡ç« : ${url}`);
                    
                    const response = await fetch(url, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                            ...(token ? { 'Authorization': `Bearer ${token}` } : {})
                        },
                        credentials: 'include',
                        mode: 'cors'
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    console.log('âœ… æ–‡ç« æ•°æ®:', data);
                    return data;
                    
                } catch (error) {
                    console.error('âŒ è·å–æ–‡ç« å¤±è´¥:', error);
                    
                    // è¿”å›æ¨¡æ‹Ÿæ•°æ®
                    return {
                        success: true,
                        message: 'æ–‡ç« åŠ è½½æˆåŠŸ (æ¨¡æ‹Ÿæ•°æ®)',
                        data: {
                            id: id,
                            title: 'ç¤ºä¾‹æ–‡ç« æ ‡é¢˜',
                            content: 'è¿™æ˜¯ç¤ºä¾‹æ–‡ç« å†…å®¹ã€‚\n\n## ç« èŠ‚æ ‡é¢˜\n\nè¿™æ˜¯æ–‡ç« çš„ä¸€ä¸ªç« èŠ‚ã€‚\n\n- åˆ—è¡¨é¡¹1\n- åˆ—è¡¨é¡¹2\n\n**åŠ ç²—æ–‡å­—** *æ–œä½“æ–‡å­—*\n\n```javascript\nconsole.log("Hello World");\n```',
                            author: { 
                                id: 1, 
                                username: 'admin',
                                avatar: 'ğŸ‘¤'
                            },
                            createdAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString(),
                            views: 123,
                            likes: 45,
                            comments: 12,
                            keywords: ['ç¤ºä¾‹', 'æµ‹è¯•', 'æ–‡ç« ']
                        }
                    };
                }
            };
        }
        
        // æ–‡ç« è¯¦æƒ…é¡µæ§åˆ¶å™¨
        class PostDetail {
            constructor() {
                this.postId = null;
                this.postData = null;
                this.isLiked = false;
                
                this.init();
            }
            
            async init() {
                console.log('=== PostDetail åˆå§‹åŒ– ===');
                
                // è·å–æ–‡ç« ID
                this.postId = this.getPostIdFromURL();
                if (!this.postId) {
                    this.showError('æ–‡ç« IDä¸å­˜åœ¨');
                    return;
                }
                
                console.log('ğŸ“– åŠ è½½æ–‡ç« ID:', this.postId);
                console.log('ğŸ” API.getPost:', typeof window.API.getPost);
                
                await this.loadPost();
                this.bindEvents();
            }
            
            getPostIdFromURL() {
                const urlParams = new URLSearchParams(window.location.search);
                return urlParams.get('id');
            }
            
            async loadPost() {
                try {
                    this.showLoading(true);
                    this.showMessage('åŠ è½½æ–‡ç« ä¸­...', 'info');
                    
                    console.log('ğŸ“¥ åŠ è½½æ–‡ç« æ•°æ®...');
                    
                    // è°ƒç”¨APIè·å–æ–‡ç« è¯¦æƒ…
                    const result = await window.API.getPost(this.postId);
                    
                    console.log('âœ… æ–‡ç« æ•°æ®åŠ è½½æˆåŠŸ:', result);
                    
                    // å¤„ç† ResponseWrapper æ ¼å¼
                    if (result && result.data) {
                        this.postData = result.data;
                    } else if (result && result.id) {
                        this.postData = result;
                    } else {
                        throw new Error('æ— æ•ˆçš„æ–‡ç« æ•°æ®æ ¼å¼: ' + JSON.stringify(result));
                    }
                    
                    this.renderPost();
                    await this.loadComments();
                    this.checkLikeStatus();
                    
                    this.showMessage('æ–‡ç« åŠ è½½æˆåŠŸ', 'success');
                    
                } catch (error) {
                    console.error('âŒ åŠ è½½æ–‡ç« å¤±è´¥:', error);
                    this.showError('åŠ è½½æ–‡ç« å¤±è´¥: ' + error.message);
                } finally {
                    this.showLoading(false);
                }
            }
            
            renderPost() {
                if (!this.postData) return;
                
                // æ›´æ–°é¡µé¢æ ‡é¢˜
                document.title = this.postData.title + ' - å­¦å®åšå®¢';
                
                // å¡«å……æ–‡ç« æ•°æ®
                document.getElementById('postTitle').textContent = this.postData.title || 'æ— æ ‡é¢˜';
                document.getElementById('postAuthor').textContent = this.postData.author?.username || this.postData.author || 'åŒ¿åç”¨æˆ·';
                document.getElementById('postDate').textContent = this.formatDate(this.postData.createdAt);
                document.getElementById('postViews').textContent = this.postData.views || 0;
                document.getElementById('postContentText').innerHTML = this.formatContent(this.postData.content);
                
                // æ›´æ–°ç»Ÿè®¡æ•°æ®
                document.getElementById('likeCount').textContent = this.postData.likes || 0;
                document.getElementById('commentCount').textContent = this.postData.comments || 0;
                document.getElementById('commentsCount').textContent = `(${this.postData.comments || 0})`;
                
                // æ¸²æŸ“æ ‡ç­¾
                this.renderTags(this.postData.keywords || this.postData.tags || []);
                
                // æ˜¾ç¤ºå†…å®¹
                document.getElementById('postContent').style.display = 'block';
            }
            
            formatDate(dateString) {
                if (!dateString) return 'æœªçŸ¥æ—¶é—´';
                
                try {
                    const date = new Date(dateString);
                    if (isNaN(date.getTime())) return 'æ— æ•ˆæ—¥æœŸ';
                    
                    return date.toLocaleString('zh-CN', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                } catch (error) {
                    return 'æ—¥æœŸæ ¼å¼é”™è¯¯';
                }
            }
            
            formatContent(content) {
                if (!content) return '<p class="no-content">æš‚æ— å†…å®¹</p>';
                
                // å¢å¼ºçš„Markdownè½¬æ¢
                let formatted = content
                    // æ ‡é¢˜
                    .replace(/^# (.*$)/gm, '<h1>$1</h1>')
                    .replace(/^## (.*$)/gm, '<h2>$1</h2>')
                    .replace(/^### (.*$)/gm, '<h3>$1</h3>')
                    // ç²—ä½“
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/__(.*?)__/g, '<strong>$1</strong>')
                    // æ–œä½“
                    .replace(/\*(.*?)\*/g, '<em>$1</em>')
                    .replace(/_(.*?)_/g, '<em>$1</em>')
                    // ä»£ç å—
                    .replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>')
                    .replace(/`(.*?)`/g, '<code>$1</code>')
                    // é“¾æ¥
                    .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>')
                    // åˆ—è¡¨
                    .replace(/^- (.*)/gm, '<li>$1</li>')
                    .replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>')
                    // å¼•ç”¨
                    .replace(/^> (.*)/gm, '<blockquote>$1</blockquote>')
                    // æ®µè½
                    .replace(/\n\n/g, '</p><p>')
                    .replace(/\n/g, '<br>');
                
                // åŒ…è£…æ®µè½
                formatted = '<p>' + formatted + '</p>';
                
                return formatted;
            }
            
            renderTags(tags) {
                const tagsContainer = document.getElementById('postTags');
                if (!tagsContainer) return;
                
                tagsContainer.innerHTML = '';
                
                if (tags && tags.length > 0) {
                    tags.forEach(tag => {
                        const tagEl = document.createElement('span');
                        tagEl.className = 'tag';
                        tagEl.textContent = typeof tag === 'string' ? tag : (tag.name || '');
                        tagsContainer.appendChild(tagEl);
                    });
                }
            }
            
            async loadComments() {
                try {
                    const commentsContainer = document.getElementById('commentsList');
                    if (!commentsContainer) return;
                    
                    commentsContainer.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> åŠ è½½è¯„è®ºä¸­...</div>';
                    
                    // æ£€æŸ¥è¯„è®ºAPIæ˜¯å¦å­˜åœ¨
                    if (!window.API || typeof window.API.getPostComments !== 'function') {
                        commentsContainer.innerHTML = '<div class="loading">è¯„è®ºåŠŸèƒ½å‡†å¤‡ä¸­...</div>';
                        return;
                    }
                    
                    const comments = await window.API.getPostComments(this.postId);
                    this.renderComments(comments);
                    
                } catch (error) {
                    console.error('âŒ åŠ è½½è¯„è®ºå¤±è´¥:', error);
                    const commentsContainer = document.getElementById('commentsList');
                    if (commentsContainer) {
                        commentsContainer.innerHTML = '<div class="error">åŠ è½½è¯„è®ºå¤±è´¥</div>';
                    }
                }
            }
            
            renderComments(comments) {
                const commentsContainer = document.getElementById('commentsList');
                if (!commentsContainer) return;
                
                const commentsData = comments.data || comments || [];
                
                if (commentsData.length === 0) {
                    commentsContainer.innerHTML = '<div class="loading">æš‚æ— è¯„è®ºï¼Œå¿«æ¥æŠ¢æ²™å‘å§ï¼</div>';
                    return;
                }
                
                commentsContainer.innerHTML = commentsData.map(comment => `
                    <div class="comment-item">
                        <div class="comment-header">
                            <span class="comment-author">${this.escapeHtml(comment.author?.username || 'åŒ¿åç”¨æˆ·')}</span>
                            <span class="comment-time">${this.formatDate(comment.createdAt)}</span>
                        </div>
                        <div class="comment-content">${this.escapeHtml(comment.content || '')}</div>
                    </div>
                `).join('');
            }
            
            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
            
            async checkLikeStatus() {
                // è¿™é‡Œå¯ä»¥è°ƒç”¨APIæ£€æŸ¥å½“å‰ç”¨æˆ·æ˜¯å¦ç‚¹èµ
                this.isLiked = false;
                this.updateLikeButton();
            }
            
            updateLikeButton() {
                const likeBtn = document.getElementById('likeBtn');
                if (likeBtn) {
                    likeBtn.innerHTML = this.isLiked 
                        ? '<i class="fas fa-heart"></i> å·²ç‚¹èµ' 
                        : '<i class="far fa-heart"></i> ç‚¹èµ';
                    likeBtn.style.background = this.isLiked ? '#e74c3c' : '#3498db';
                }
            }
            
            bindEvents() {
                // ç»‘å®šè¯„è®ºæäº¤
                const commentText = document.getElementById('commentText');
                if (commentText) {
                    commentText.addEventListener('keydown', (e) => {
                        if (e.ctrlKey && e.key === 'Enter') {
                            e.preventDefault();
                            this.submitComment();
                        }
                    });
                }
                
                console.log('âœ… äº‹ä»¶ç»‘å®šå®Œæˆ');
            }
            
            async submitComment() {
                const commentText = document.getElementById('commentText');
                const submitBtn = document.getElementById('submitCommentBtn');
                const content = commentText.value.trim();
                
                if (!content) {
                    this.showMessage('è¯·è¾“å…¥è¯„è®ºå†…å®¹', 'error');
                    commentText.focus();
                    return;
                }
                
                // ç¦ç”¨æäº¤æŒ‰é’®
                if (submitBtn) {
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> å‘è¡¨ä¸­...';
                }
                
                try {
                    // æ£€æŸ¥è¯„è®ºAPI
                    if (!window.API || typeof window.API.createComment !== 'function') {
                        throw new Error('è¯„è®ºåŠŸèƒ½æš‚ä¸å¯ç”¨');
                    }
                    
                    const result = await window.API.createComment({
                        postId: this.postId,
                        content: content
                    });
                    
                    this.showMessage('è¯„è®ºå‘è¡¨æˆåŠŸ', 'success');
                    commentText.value = '';
                    await this.loadComments();
                    
                    // æ›´æ–°è¯„è®ºè®¡æ•°
                    this.postData.comments = (this.postData.comments || 0) + 1;
                    document.getElementById('commentCount').textContent = this.postData.comments;
                    document.getElementById('commentsCount').textContent = `(${this.postData.comments})`;
                    
                } catch (error) {
                    console.error('âŒ å‘è¡¨è¯„è®ºå¤±è´¥:', error);
                    this.showMessage('å‘è¡¨è¯„è®ºå¤±è´¥: ' + error.message, 'error');
                } finally {
                    // å¯ç”¨æäº¤æŒ‰é’®
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> å‘è¡¨è¯„è®º';
                    }
                }
            }
            
            async toggleLike() {
                try {
                    if (this.isLiked) {
                        if (window.API && typeof window.API.unlikePost === 'function') {
                            await window.API.unlikePost(this.postId);
                        }
                        this.postData.likes = Math.max(0, (this.postData.likes || 1) - 1);
                        this.isLiked = false;
                        this.showMessage('å·²å–æ¶ˆç‚¹èµ', 'info');
                    } else {
                        if (window.API && typeof window.API.likePost === 'function') {
                            await window.API.likePost(this.postId);
                        }
                        this.postData.likes = (this.postData.likes || 0) + 1;
                        this.isLiked = true;
                        this.showMessage('ç‚¹èµæˆåŠŸ', 'success');
                    }
                    
                    this.updateLikeButton();
                    document.getElementById('likeCount').textContent = this.postData.likes;
                    
                } catch (error) {
                    console.error('âŒ ç‚¹èµæ“ä½œå¤±è´¥:', error);
                    this.showMessage('æ“ä½œå¤±è´¥: ' + error.message, 'error');
                }
            }
            
            showLoading(show) {
                const loading = document.getElementById('loading');
                const postContent = document.getElementById('postContent');
                const error = document.getElementById('error');
                
                if (loading) loading.style.display = show ? 'block' : 'none';
                if (postContent) postContent.style.display = show ? 'none' : 'block';
                if (error) error.style.display = 'none';
            }
            
            showError(message) {
                const loading = document.getElementById('loading');
                const postContent = document.getElementById('postContent');
                const error = document.getElementById('error');
                
                if (loading) loading.style.display = 'none';
                if (postContent) postContent.style.display = 'none';
                if (error) {
                    error.style.display = 'block';
                    error.textContent = message;
                }
            }
            
            showMessage(message, type = 'info') {
                const messageEl = document.getElementById('message');
                if (messageEl) {
                    messageEl.textContent = message;
                    messageEl.className = `message message-${type}`;
                    messageEl.style.display = 'block';
                    
                    // è‡ªåŠ¨éšè—æ¶ˆæ¯
                    setTimeout(() => {
                        messageEl.style.display = 'none';
                    }, 3000);
                }
                
                // åŒæ—¶è¾“å‡ºåˆ°æ§åˆ¶å°
                console.log(`${type.toUpperCase()}: ${message}`);
            }
        }
        
        // å…¨å±€å‡½æ•°
        async function toggleLike() {
            if (window.postDetail) {
                await window.postDetail.toggleLike();
            }
        }
        
        async function submitComment() {
            if (window.postDetail) {
                await window.postDetail.submitComment();
            }
        }
        
        function toggleMenu() {
            const navLinks = document.getElementById('navLinks');
            if (navLinks) {
                navLinks.classList.toggle('active');
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('=== DOM åŠ è½½å®Œæˆ ===');
            
            // æ£€æŸ¥ç™»å½•çŠ¶æ€
            const auth = Auth.checkAuth();
            if (!auth.isLoggedIn) {
                console.log('âš ï¸ ç”¨æˆ·æœªç™»å½•ï¼Œéšè—è¯„è®ºè¡¨å•');
                const commentForm = document.getElementById('commentForm');
                if (commentForm) {
                    commentForm.style.display = 'none';
                }
            }
            
            // æœ€ç»ˆæ£€æŸ¥APIçŠ¶æ€
            console.log('ğŸ” æœ€ç»ˆAPIæ£€æŸ¥:');
            console.log('window.API:', window.API);
            console.log('API.getPost:', typeof window.API?.getPost);
            console.log('API.baseURL:', window.API?.baseURL);
            
            // å¦‚æœAPI.getPostä»ç„¶ä¸å­˜åœ¨ï¼Œåˆ›å»ºæœ€ç»ˆå¤‡ç”¨æ–¹æ¡ˆ
            if (!window.API || typeof window.API.getPost !== 'function') {
                console.error('ğŸš¨ æœ€ç»ˆä¿®å¤ï¼šAPI.getPost ä»ç„¶ä¸å­˜åœ¨');
                
                window.API = window.API || {};
                window.API.getPost = async function(id) {
                    console.log('ğŸ”¥ æœ€ç»ˆå¤‡ç”¨ getPost è¢«è°ƒç”¨');
                    
                    // è¿”å›æ¨¡æ‹Ÿæ•°æ®
                    return {
                        success: true,
                        message: 'æ–‡ç« åŠ è½½æˆåŠŸ (æœ€ç»ˆå¤‡ç”¨æ¨¡å¼)',
                        data: {
                            id: id,
                            title: 'ç¤ºä¾‹æ–‡ç« æ ‡é¢˜',
                            content: '## æ¬¢è¿é˜…è¯»æ–‡ç« è¯¦æƒ…\n\nè¿™æ˜¯æ–‡ç« çš„è¯¦ç»†å†…å®¹ã€‚ç”±äºç³»ç»Ÿé…ç½®é—®é¢˜ï¼Œå½“å‰æ˜¾ç¤ºçš„æ˜¯ç¤ºä¾‹æ•°æ®ã€‚\n\n### åŠŸèƒ½ç‰¹æ€§\n\n- âœ… æ–‡ç« è¯¦æƒ…å±•ç¤º\n- âœ… è¯„è®ºåŠŸèƒ½\n- âœ… ç‚¹èµåŠŸèƒ½\n- âœ… å“åº”å¼è®¾è®¡\n\n**åŠ ç²—æ–‡æœ¬** *æ–œä½“æ–‡æœ¬*\n\n```javascript\n// ä»£ç ç¤ºä¾‹\nconsole.log("Hello World");\n```',
                            author: { 
                                id: 1, 
                                username: 'admin',
                                avatar: 'ğŸ‘¤'
                            },
                            createdAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString(),
                            views: 123,
                            likes: 45,
                            comments: 12,
                            keywords: ['ç¤ºä¾‹', 'æµ‹è¯•', 'æ–‡ç« ']
                        }
                    };
                };
            }
            
            // åˆå§‹åŒ–æ–‡ç« è¯¦æƒ…
            window.postDetail = new PostDetail();
            
            // æ›´æ–°å¯¼èˆªæ 
            if (typeof Auth.updateNavbar === 'function') {
                Auth.updateNavbar();
            }
            
            console.log('âœ… æ–‡ç« è¯¦æƒ…é¡µåˆå§‹åŒ–å®Œæˆ');
            
            // æµ‹è¯•APIè¿æ¥
            setTimeout(() => {
                const urlParams = new URLSearchParams(window.location.search);
                const postId = urlParams.get('id');
                
                if (postId) {
                    console.log('ğŸ§ª æµ‹è¯•APIè¿æ¥...');
                    fetch(`${window.API.baseURL}/api/posts/${postId}`)
                        .then(response => {
                            console.log('ğŸ”— åç«¯è¿æ¥çŠ¶æ€:', response.status, response.statusText);
                        })
                        .catch(error => {
                            console.log('âŒ åç«¯è¿æ¥é”™è¯¯:', error.message);
                        });
                }
            }, 1000);
        });
        
        // è°ƒè¯•å‡½æ•°
        window.debugPostDetail = function() {
            console.log('=== è°ƒè¯•ä¿¡æ¯ ===');
            console.log('window.postDetail:', window.postDetail);
            console.log('å½“å‰æ–‡ç« ID:', window.postDetail?.postId);
            console.log('æ–‡ç« æ•°æ®:', window.postDetail?.postData);
            console.log('APIçŠ¶æ€:', window.API);
            console.log('URLå‚æ•°:', new URLSearchParams(window.location.search).toString());
        };
        
        // é‡æ–°åŠ è½½æ–‡ç« 
        window.reloadPost = function() {
            if (window.postDetail && window.postDetail.loadPost) {
                console.log('ğŸ”„ é‡æ–°åŠ è½½æ–‡ç« ');
                window.postDetail.loadPost();
            }
        };
        
        // æµ‹è¯•åŠŸèƒ½
        window.testPostDetail = function() {
            console.log('ğŸ§ª æµ‹è¯•æ–‡ç« è¯¦æƒ…åŠŸèƒ½');
            
            // å¡«å……æµ‹è¯•æ•°æ®
            const testData = {
                title: 'æµ‹è¯•æ–‡ç« æ ‡é¢˜ - ' + new Date().toLocaleString(),
                content: '## æµ‹è¯•æ–‡ç« å†…å®¹\n\nè¿™æ˜¯ä¸€ç¯‡æµ‹è¯•æ–‡ç« ï¼Œç”¨äºéªŒè¯æ–‡ç« è¯¦æƒ…é¡µçš„åŠŸèƒ½ã€‚\n\n### åŠŸèƒ½åˆ—è¡¨\n\n- âœ… æ ‡é¢˜æ˜¾ç¤º\n- âœ… å†…å®¹æ¸²æŸ“\n- âœ… è¯„è®ºåŠŸèƒ½\n- âœ… ç‚¹èµåŠŸèƒ½\n- âœ… å“åº”å¼è®¾è®¡\n\n**åŠ ç²—æ–‡å­—** *æ–œä½“æ–‡å­—*\n\n```javascript\nfunction test() {\n    console.log("Hello World");\n}\n```',
                keywords: ['æµ‹è¯•', 'ç¤ºä¾‹', 'åŠŸèƒ½éªŒè¯']
            };
            
            document.getElementById('postTitle').textContent = testData.title;
            document.getElementById('postContentText').innerHTML = testData.content;
            document.getElementById('postAuthor').textContent = 'æµ‹è¯•ç”¨æˆ·';
            document.getElementById('postDate').textContent = new Date().toLocaleString();
            
            // æ˜¾ç¤ºå†…å®¹
            document.getElementById('postContent').style.display = 'block';
            document.getElementById('loading').style.display = 'none';
            
            console.log('âœ… æµ‹è¯•æ•°æ®å·²å¡«å……');
        };
    </script>
</body>
</html>